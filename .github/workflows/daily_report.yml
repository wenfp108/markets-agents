name: Daily Heatmap & JSON Report

# æ¯å¤©åŒ—äº¬æ—¶é—´ 23:55 è‡ªåŠ¨è¿è¡Œ
on:
  schedule:
    - cron: '55 15 * * *'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build-report:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      - name: Generate Reports
        run: |
          cat <<'EOF' > analyzer.py
          import os
          import json
          
          # === 1. æ™ºèƒ½æŸ¥æ‰¾æœ€æ–°æ•°æ® ===
          data_root = "data"
          if not os.path.exists(data_root):
              print("æ— æ•°æ®ç›®å½•"); exit(0)
          
          all_dirs = [d for d in os.listdir(data_root) if d[0].isdigit()]
          all_dirs.sort()
          if not all_dirs: print("æ— æ•°æ®"); exit(0)
              
          latest_date = all_dirs[-1] 
          source_dir = os.path.join(data_root, latest_date)
          
          report_dir = "reports"
          if not os.path.exists(report_dir): os.makedirs(report_dir)
          print(f"ğŸ¯ åˆ†ææº: {source_dir}")

          # === 2. è¾…åŠ©å‡½æ•°ï¼šæ‰¾æ´»è·ƒçš„ä¸»åŠ›ç›˜å£ ===
          def get_active_market(market_data):
              if 'markets' not in market_data or not market_data['markets']:
                  return None
              
              # â˜…â˜…â˜… æ ¸å¿ƒä¿®å¤ï¼šä¼˜å…ˆæ‰¾è¿˜æ²¡ç»“æŸ(closed=False)çš„ç›˜å£ â˜…â˜…â˜…
              valid_markets = market_data['markets']
              
              # 1. å°è¯•è¿‡æ»¤æ‰æ‰€æœ‰ closed: true çš„ç›˜å£
              active_markets = [m for m in valid_markets if not m.get('closed', False)]
              
              # 2. å¦‚æœæœ‰æ´»ç€çš„ï¼Œå°±ç”¨æ´»ç€çš„ï¼›å¦‚æœå…¨æ­»å…‰äº†ï¼Œå°±åªèƒ½ç”¨ç¬¬ä¸€ä¸ª
              target_list = active_markets if active_markets else valid_markets
              
              # 3. åœ¨æ´»ç€çš„ç›˜å£é‡Œï¼Œæ‰¾æˆäº¤é‡(volume)æœ€å¤§çš„é‚£ä¸ªï¼ˆé€šå¸¸æ˜¯ä¸»æˆ˜åœºï¼‰
              # è¿™æ ·åšèƒ½é¿å…æŠ“åˆ°å†·é—¨çš„å­é€‰é¡¹
              try:
                  # æœ‰äº› volume æ˜¯å­—ç¬¦ä¸²ï¼Œæœ‰äº›æ˜¯æ•°å­—ï¼Œåšä¸ªé˜²å‘†å¤„ç†
                  target_list.sort(key=lambda x: float(str(x.get('volume', 0))), reverse=True)
                  return target_list[0]
              except:
                  return target_list[0]

          # === 3. è¾…åŠ©å‡½æ•°ï¼šè§£æèµ¢å®¶ ===
          def get_top_candidate(market_item):
              if not market_item: return None
              try:
                  outcomes = market_item.get('outcomes')
                  if isinstance(outcomes, str): outcomes = json.loads(outcomes)
                  prices = market_item.get('outcomePrices')
                  if isinstance(prices, str): prices = json.loads(prices)
                  
                  if not outcomes or not prices: return None
                  
                  candidates = []
                  for i in range(len(outcomes)):
                      p = float(prices[i])
                      name = str(outcomes[i])
                      candidates.append((name, p))
                  
                  candidates.sort(key=lambda x: x[1], reverse=True)
                  return candidates[0]
              except: return None

          # === 4. è¾…åŠ©å‡½æ•°ï¼šæ™ºèƒ½æ—¶é—´è½´ ===
          def generate_smart_timeline(history_list):
              history_list.sort(key=lambda x: x[0])
              if not history_list: return "æ— æ•°æ®", []
              
              key_frames = []
              last_state_str = ""
              last_winner = ""

              for ts, content in history_list:
                  data = content.get('data', {})
                  
                  # ä½¿ç”¨æ–°çš„é€»è¾‘ï¼šæ‰¾æ´»è·ƒç›˜å£
                  active_m = get_active_market(data)
                  top = get_top_candidate(active_m)
                  
                  if top:
                      name, prob = top
                      # çŠ¶æ€æŒ‡çº¹
                      current_state_str = f"{name}|{int(prob*100)}"
                      
                      if current_state_str != last_state_str:
                          try: time_label = ts.split('T')[1][:5]
                          except: time_label = ""
                          
                          key_frames.append({
                              "time": time_label,
                              "name": name,
                              "prob": prob,
                              "is_flip": (last_winner != "" and name != last_winner)
                          })
                          last_state_str = current_state_str
                          last_winner = name
              
              # ç”Ÿæˆ Markdown
              md_parts = []
              for kf in key_frames:
                  t_prefix = f"*{kf['time']}* " if kf['time'] else ""
                  prob_fmt = f"{kf['prob']*100:.0f}%"
                  item_str = f"{t_prefix}{kf['name']}({prob_fmt})"
                  
                  if kf['is_flip']: md_parts.append(f"ğŸ”€ `{item_str}`")
                  else: md_parts.append(f"`{item_str}`")
              
              timeline_md = " â†’ ".join(md_parts)
              return timeline_md, key_frames

          # === 5. ä¸»å¾ªç¯ ===
          event_map = {}
          for filename in os.listdir(source_dir):
              if filename.endswith(".json"):
                  try:
                      with open(os.path.join(source_dir, filename), 'r') as f:
                          content = json.load(f)
                          meta = content.get('meta', {})
                          data = content.get('data', {})
                          eid = meta.get('id', data.get('slug', 'unknown'))
                          
                          if eid not in event_map:
                              event_map[eid] = { "count": 0, "history": [], "latest_data": content }
                          
                          event_map[eid]["count"] += 1
                          ts = meta.get('fetch_time_iso', filename)
                          event_map[eid]["history"].append((ts, content))
                          
                          if float(data.get('volume', 0)) > float(event_map[eid]['latest_data'].get('data', {}).get('volume', 0)):
                              event_map[eid]['latest_data'] = content
                  except: pass

          # === 6. ç”ŸæˆæŠ¥å‘Š ===
          report_list = []
          for eid, info in event_map.items():
              raw_data = info['latest_data']
              data = raw_data.get('data', {})
              meta = raw_data.get('meta', {})
              
              # â˜… è¿™é‡Œä¹Ÿè¦ç”¨æ–°é€»è¾‘
              active_m = get_active_market(data)
              top = get_top_candidate(active_m)
              consensus = f"ğŸ‘‘ {top[0]} ({top[1]*100:.1f}%)" if top else "N/A"
              
              t_str, t_data = generate_smart_timeline(info['history'])
              
              # è·å–å…·ä½“çš„å­æ ‡é¢˜ (æ¯”å¦‚ "Dec 2026") è®©æ˜¾ç¤ºæ›´æ¸…æ¥š
              sub_title = ""
              if active_m and 'groupItemTitle' in active_m:
                  sub_title = f" [{active_m['groupItemTitle']}]"

              report_item = {
                  "id": eid,
                  "title": (meta.get('title', data.get('title', eid)) + sub_title), # æ ‡é¢˜åŠ ä¸Šå…·ä½“æ—¥æœŸ
                  "sector": meta.get('sector_tag', 'General'),
                  "heat_count": info['count'],
                  "volume": float(data.get('volume', 0)),
                  "consensus": consensus,
                  "timeline_md": t_str,
                  "timeline_data": t_data,
                  "url": f"https://polymarket.com/event/{eid}"
              }
              report_list.append(report_item)

          report_list.sort(key=lambda x: (x['heat_count'], x['volume']), reverse=True)

          md = f"# ğŸ“Š 24H æ™ºèƒ½å¤ç›˜ ({latest_date})\n\n"
          md += f"**ç”Ÿæˆæ—¶é—´**: 23:55 | **å»é‡é€»è¾‘**: ä¼˜å…ˆå±•ç¤ºæ´»è·ƒ(Active)ç›˜å£\n\n"
          md += "| çƒ­åº¦ | æ¿å— | äº‹ä»¶æ ‡é¢˜ | ğŸ”¥ æœ€ç»ˆèµ¢å®¶ | ğŸŒŠ èµ„é‡‘åšå¼ˆå…³é”®å¸§ |\n| :--- | :--- | :--- | :--- | :--- |\n"
          for item in report_list:
              icon = "ğŸ”¥ğŸ”¥ğŸ”¥" if item['heat_count']>=20 else "ğŸ”¥" if item['heat_count']>=10 else "â­ï¸"
              title = item['title'][:50] + "..." if len(item['title']) > 50 else item['title']
              md += f"| {icon} | {item['sector']} | [{title}]({item['url']}) | {item['consensus']} | {item['timeline_md']} |\n"

          with open(f"{report_dir}/DAILY_HEATMAP_{latest_date}.md", "w") as f:
              f.write(md)

          with open(f"{report_dir}/DAILY_SUMMARY_{latest_date}.json", "w") as f:
              json.dump(report_list, f, indent=2)

          print(f"âœ… V12 å®Œæˆï¼")
          EOF

          python analyzer.py

      - name: Commit results
        run: |
          git config --global user.name "Report Bot"
          git config --global user.email "bot@github.com"
          git add reports/
          git commit -m "ğŸ“Š V12 Filter Closed Markets" || exit 0
          git push
