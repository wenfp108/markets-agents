name: Daily Heatmap & JSON Report

# æ¯å¤©åŒ—äº¬æ—¶é—´ 23:30 (UTC 15:30) è‡ªåŠ¨è¿è¡Œ
on:
  schedule:
    - cron: '30 15 * * *'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build-report:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      - name: Generate Reports
        run: |
          # æ³¨æ„ï¼šè¿™é‡Œçš„ EOF åŠ äº†å•å¼•å·ï¼Œé˜²æ­¢ Shell è¯¯è¯» $ ç¬¦å·
          cat <<'EOF' > analyzer.py
          import os
          import json
          from datetime import datetime
          import pytz

          # 1. è®¾å®šè¾“å…¥ç›®å½• (è¯»æ•°æ®çš„åœ°æ–¹)
          tz = pytz.timezone('Asia/Shanghai')
          today_str = datetime.now(tz).strftime('%Y-%m-%d')
          source_dir = f"data/{today_str}"
          
          # 2. è®¾å®šè¾“å‡ºç›®å½• (å­˜æŠ¥è¡¨çš„åœ°æ–¹ -> ç‹¬ç«‹çš„ reports æ–‡ä»¶å¤¹)
          report_dir = "reports"
          if not os.path.exists(report_dir):
              os.makedirs(report_dir) # å¦‚æœæ²¡æœ‰å°±æ–°å»º

          print(f"æ­£åœ¨åˆ†æç›®å½•: {source_dir}")

          if not os.path.exists(source_dir):
              print("ä»Šæ—¥æ— æ•°æ®ã€‚")
              exit(0)

          # 3. æ ¸å¿ƒèšåˆé€»è¾‘
          event_map = {}
          file_count = 0

          for filename in os.listdir(source_dir):
              # åªè¯»åŸå§‹ JSONï¼Œä¸è¯»å…¶ä»–ä¹±ä¸ƒå…«ç³Ÿçš„
              if filename.endswith(".json"):
                  file_count += 1
                  filepath = os.path.join(source_dir, filename)
                  try:
                      with open(filepath, 'r') as f:
                          content = json.load(f)
                          
                          meta = content.get('meta', {})
                          data = content.get('data', {})
                          event_id = meta.get('id', data.get('slug', 'unknown'))
                          
                          if event_id not in event_map:
                              event_map[event_id] = {
                                  "count": 0,
                                  "latest_data": content 
                              }
                          
                          event_map[event_id]["count"] += 1
                          
                          current_vol = float(data.get('volume', 0))
                          saved_vol = float(event_map[event_id]['latest_data'].get('data', {}).get('volume', 0))
                          
                          if current_vol > saved_vol:
                              event_map[event_id]['latest_data'] = content

                  except Exception as e:
                      print(f"Error reading {filename}: {e}")

          # === å‡†å¤‡æ•°æ® ===
          report_list = []
          raw_data_list = []

          for eid, info in event_map.items():
              raw_data = info['latest_data']
              raw_data_list.append(raw_data)

              data = raw_data.get('data', {})
              meta = raw_data.get('meta', {})
              
              top_outcome = "N/A"
              top_prob = 0
              if 'markets' in data and len(data['markets']) > 0:
                  m = data['markets'][0]
                  try:
                      prices = json.loads(m.get('outcomePrices', '[]'))
                      outcomes = json.loads(m.get('outcomes', '[]'))
                      if prices and outcomes:
                          max_p = max(prices)
                          idx = prices.index(max_p)
                          top_outcome = outcomes[idx]
                          top_prob = float(max_p) * 100
                  except:
                      pass

              report_list.append({
                  "title": meta.get('title', data.get('title', eid)),
                  "sector": meta.get('sector_tag', 'General'),
                  "count": info['count'],
                  "volume": float(data.get('volume', 0)),
                  "prob_str": f"{top_outcome} ({top_prob:.1f}%)",
                  "url": f"https://polymarket.com/event/{eid}"
              })

          report_list.sort(key=lambda x: (x['count'], x['volume']), reverse=True)

          # === è¾“å‡º 1: Markdown åˆ° reports/ æ–‡ä»¶å¤¹ ===
          md = f"# ğŸ“Š å…¨å¤©å€™çƒ­åŠ›æˆ˜æŠ¥ ({today_str})\n\n"
          md += f"**æ–‡ä»¶é‡‡æ ·**: {file_count} | **å»é‡äº‹ä»¶**: {len(report_list)}\n\n"
          md += "| çƒ­åº¦ | æ¿å— | äº‹ä»¶æ ‡é¢˜ | å…±è¯† | èµ„é‡‘ |\n"
          md += "| :--- | :--- | :--- | :--- | :--- |\n"

          for item in report_list:
              count = item['count']
              if count >= 20: icon = "ğŸ”¥ğŸ”¥ğŸ”¥"
              elif count >=
